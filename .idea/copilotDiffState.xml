<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/github/markpairdha/whatsapp/ChatsFragment.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/github/markpairdha/whatsapp/ChatsFragment.java" />
              <option name="originalContent" value="package com.github.markpairdha.whatsapp;&#10;&#10;&#10;import android.content.Intent;&#10;import android.os.Bundle;&#10;&#10;import androidx.annotation.NonNull;&#10;import androidx.fragment.app.Fragment;&#10;import androidx.recyclerview.widget.LinearLayoutManager;&#10;import androidx.recyclerview.widget.RecyclerView;&#10;&#10;import android.view.LayoutInflater;&#10;import android.view.View;&#10;import android.view.ViewGroup;&#10;import android.widget.TextView;&#10;&#10;import com.firebase.ui.database.FirebaseRecyclerAdapter;&#10;import com.firebase.ui.database.FirebaseRecyclerOptions;&#10;import com.google.firebase.auth.FirebaseAuth;&#10;import com.google.firebase.database.DataSnapshot;&#10;import com.google.firebase.database.DatabaseError;&#10;import com.google.firebase.database.DatabaseReference;&#10;import com.google.firebase.database.FirebaseDatabase;&#10;import com.google.firebase.database.ValueEventListener;&#10;import com.squareup.picasso.Picasso;&#10;&#10;import java.util.HashMap;&#10;import java.util.Map;&#10;&#10;import de.hdodenhof.circleimageview.CircleImageView;&#10;&#10;&#10;public class ChatsFragment extends Fragment&#10;{&#10;    private View PrivateChatsView;&#10;    private RecyclerView chatsList;&#10;&#10;    private DatabaseReference ChatsRef, UsersRef;&#10;    private FirebaseAuth mAuth;&#10;    private String currentUserID=&quot;&quot;;&#10;    private Map&lt;String, ValueEventListener&gt; userListenersMap = new HashMap&lt;&gt;();&#10;&#10;    public ChatsFragment()&#10;    {&#10;&#10;    }&#10;&#10;&#10;    @Override&#10;    public View onCreateView(LayoutInflater inflater, ViewGroup container,&#10;                             Bundle savedInstanceState) {&#10;        PrivateChatsView = inflater.inflate(R.layout.fragment_chats, container, false);&#10;&#10;        mAuth = FirebaseAuth.getInstance();&#10;        if (mAuth.getCurrentUser() == null) {&#10;            return null;&#10;        }&#10;        currentUserID = mAuth.getCurrentUser().getUid();&#10;        ChatsRef = FirebaseDatabase.getInstance().getReference().child(&quot;Contacts&quot;).child(currentUserID);&#10;        UsersRef = FirebaseDatabase.getInstance().getReference().child(&quot;Users&quot;);&#10;&#10;        chatsList = (RecyclerView) PrivateChatsView.findViewById(R.id.chats_list);&#10;        chatsList.setLayoutManager(new LinearLayoutManager(getContext()));&#10;&#10;        return PrivateChatsView;&#10;    }&#10;    @Override&#10;    public void onStart()&#10;    {&#10;        super.onStart();&#10;&#10;&#10;        FirebaseRecyclerOptions&lt;Contacts&gt; options =&#10;                new FirebaseRecyclerOptions.Builder&lt;Contacts&gt;()&#10;                        .setQuery(ChatsRef, Contacts.class)&#10;                        .build();&#10;&#10;&#10;        FirebaseRecyclerAdapter&lt;Contacts, ChatsViewHolder&gt; adapter =&#10;                new FirebaseRecyclerAdapter&lt;Contacts, ChatsViewHolder&gt;(options) {&#10;                    @Override&#10;                    protected void onBindViewHolder(@NonNull final ChatsViewHolder holder, int position, @NonNull Contacts model)&#10;                    {&#10;                        final String usersIDs = getRef(position).getKey();&#10;                        final String[] retImage = {&quot;default_image&quot;};&#10;                        final String[] retName = {&quot;User&quot;};&#10;&#10;                        // Remove old listener if it exists&#10;                        if (userListenersMap.containsKey(usersIDs)) {&#10;                            UsersRef.child(usersIDs).removeEventListener(userListenersMap.get(usersIDs));&#10;                        }&#10;&#10;                        // Create a new ValueEventListener that updates whenever the user data changes&#10;                        ValueEventListener userListener = new ValueEventListener() {&#10;                            @Override&#10;                            public void onDataChange(DataSnapshot dataSnapshot)&#10;                            {&#10;                                if (dataSnapshot.exists())&#10;                                {&#10;                                    if (dataSnapshot.hasChild(&quot;image&quot;))&#10;                                    {&#10;                                        retImage[0] = dataSnapshot.child(&quot;image&quot;).getValue().toString();&#10;                                        if (retImage[0] != null &amp;&amp; !retImage[0].isEmpty()) {&#10;                                            Picasso.get().load(retImage[0]).into(holder.profileImage);&#10;                                        }&#10;                                    }&#10;&#10;                                    if (dataSnapshot.hasChild(&quot;name&quot;))&#10;                                    {&#10;                                        retName[0] = dataSnapshot.child(&quot;name&quot;).getValue().toString();&#10;                                        holder.userName.setText(retName[0]);&#10;                                    }&#10;&#10;                                    // Update user status - this is the key part that checks if online/offline&#10;                                    if (dataSnapshot.hasChild(&quot;userState&quot;))&#10;                                    {&#10;                                        if (dataSnapshot.child(&quot;userState&quot;).hasChild(&quot;state&quot;))&#10;                                        {&#10;                                            String state = dataSnapshot.child(&quot;userState&quot;).child(&quot;state&quot;).getValue().toString();&#10;                                            &#10;                                            if (state != null) {&#10;                                                if (state.equals(&quot;online&quot;))&#10;                                                {&#10;                                                    holder.userStatus.setText(&quot;online&quot;);&#10;                                                }&#10;                                                else if (state.equals(&quot;offline&quot;))&#10;                                                {&#10;                                                    String date = &quot;&quot;;&#10;                                                    String time = &quot;&quot;;&#10;                                                    &#10;                                                    if (dataSnapshot.child(&quot;userState&quot;).hasChild(&quot;date&quot;)) {&#10;                                                        date = dataSnapshot.child(&quot;userState&quot;).child(&quot;date&quot;).getValue().toString();&#10;                                                    }&#10;                                                    if (dataSnapshot.child(&quot;userState&quot;).hasChild(&quot;time&quot;)) {&#10;                                                        time = dataSnapshot.child(&quot;userState&quot;).child(&quot;time&quot;).getValue().toString();&#10;                                                    }&#10;                                                    &#10;                                                    holder.userStatus.setText(&quot;Last Seen: &quot; + date + &quot; &quot; + time);&#10;                                                }&#10;                                            }&#10;                                        }&#10;                                    }&#10;                                    else&#10;                                    {&#10;                                        holder.userStatus.setText(&quot;offline&quot;);&#10;                                    }&#10;                                }&#10;                            }&#10;&#10;                            @Override&#10;                            public void onCancelled(DatabaseError databaseError) {&#10;&#10;                            }&#10;                        };&#10;&#10;                        // Store the listener and add it to continuously monitor user state changes&#10;                        userListenersMap.put(usersIDs, userListener);&#10;                        UsersRef.child(usersIDs).addValueEventListener(userListener);&#10;&#10;                        // Set click listener outside of ValueEventListener to ensure it's always set&#10;                        holder.itemView.setOnClickListener(new View.OnClickListener() {&#10;                            @Override&#10;                            public void onClick(View view)&#10;                            {&#10;                                Intent chatIntent = new Intent(getContext(), ChatActivity.class);&#10;                                chatIntent.putExtra(&quot;visit_user_id&quot;, usersIDs);&#10;                                chatIntent.putExtra(&quot;visit_user_name&quot;, retName[0]);&#10;                                chatIntent.putExtra(&quot;visit_image&quot;, retImage[0]);&#10;                                startActivity(chatIntent);&#10;                            }&#10;                        });&#10;                    }&#10;&#10;                    @NonNull&#10;                    @Override&#10;                    public ChatsViewHolder onCreateViewHolder(@NonNull ViewGroup viewGroup, int i)&#10;                    {&#10;                        View view = LayoutInflater.from(viewGroup.getContext()).inflate(R.layout.users_display_layout, viewGroup, false);&#10;                        return new ChatsViewHolder(view);&#10;                    }&#10;                };&#10;&#10;        if (chatsList != null) {&#10;            chatsList.setAdapter(adapter);&#10;            adapter.startListening();&#10;        }&#10;    }&#10;&#10;&#10;&#10;&#10;    @Override&#10;    public void onDestroy() {&#10;        super.onDestroy();&#10;        // Remove all listeners to prevent memory leaks&#10;        for (String userId : userListenersMap.keySet()) {&#10;            UsersRef.child(userId).removeEventListener(userListenersMap.get(userId));&#10;        }&#10;        userListenersMap.clear();&#10;    }&#10;&#10;&#10;    public static class  ChatsViewHolder extends RecyclerView.ViewHolder&#10;    {&#10;        CircleImageView profileImage;&#10;        TextView userStatus, userName;&#10;&#10;        public ChatsViewHolder(@NonNull View itemView)&#10;        {&#10;            super(itemView);&#10;&#10;            profileImage = itemView.findViewById(R.id.users_profile_image);&#10;            userStatus = itemView.findViewById(R.id.user_status);&#10;            userName = itemView.findViewById(R.id.user_profile_name);&#10;        }&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="package com.github.markpairdha.whatsapp;&#10;&#10;&#10;import android.content.Intent;&#10;import android.os.Bundle;&#10;&#10;import androidx.annotation.NonNull;&#10;import androidx.fragment.app.Fragment;&#10;import androidx.recyclerview.widget.LinearLayoutManager;&#10;import androidx.recyclerview.widget.RecyclerView;&#10;&#10;import android.view.LayoutInflater;&#10;import android.view.View;&#10;import android.view.ViewGroup;&#10;import android.widget.TextView;&#10;&#10;import com.firebase.ui.database.FirebaseRecyclerAdapter;&#10;import com.firebase.ui.database.FirebaseRecyclerOptions;&#10;import com.google.firebase.auth.FirebaseAuth;&#10;import com.google.firebase.database.DataSnapshot;&#10;import com.google.firebase.database.DatabaseError;&#10;import com.google.firebase.database.DatabaseReference;&#10;import com.google.firebase.database.FirebaseDatabase;&#10;import com.google.firebase.database.ValueEventListener;&#10;import com.squareup.picasso.Picasso;&#10;&#10;import java.util.HashMap;&#10;import java.util.Map;&#10;&#10;import de.hdodenhof.circleimageview.CircleImageView;&#10;&#10;&#10;public class ChatsFragment extends Fragment&#10;{&#10;    private View PrivateChatsView;&#10;    private RecyclerView chatsList;&#10;&#10;    private DatabaseReference ChatsRef, UsersRef;&#10;    private FirebaseAuth mAuth;&#10;    private String currentUserID=&quot;&quot;;&#10;    private Map&lt;String, ValueEventListener&gt; userListenersMap = new HashMap&lt;&gt;();&#10;&#10;    public ChatsFragment()&#10;    {&#10;&#10;    }&#10;&#10;&#10;    @Override&#10;    public View onCreateView(LayoutInflater inflater, ViewGroup container,&#10;                             Bundle savedInstanceState) {&#10;        PrivateChatsView = inflater.inflate(R.layout.fragment_chats, container, false);&#10;&#10;        mAuth = FirebaseAuth.getInstance();&#10;        if (mAuth.getCurrentUser() == null) {&#10;            return null;&#10;        }&#10;        currentUserID = mAuth.getCurrentUser().getUid();&#10;        ChatsRef = FirebaseDatabase.getInstance().getReference().child(&quot;Contacts&quot;).child(currentUserID);&#10;        UsersRef = FirebaseDatabase.getInstance().getReference().child(&quot;Users&quot;);&#10;&#10;        chatsList = (RecyclerView) PrivateChatsView.findViewById(R.id.chats_list);&#10;        chatsList.setLayoutManager(new LinearLayoutManager(getContext()));&#10;&#10;        return PrivateChatsView;&#10;    }&#10;    @Override&#10;    public void onStart()&#10;    {&#10;        super.onStart();&#10;&#10;&#10;        FirebaseRecyclerOptions&lt;Contacts&gt; options =&#10;                new FirebaseRecyclerOptions.Builder&lt;Contacts&gt;()&#10;                        .setQuery(ChatsRef, Contacts.class)&#10;                        .build();&#10;&#10;&#10;        FirebaseRecyclerAdapter&lt;Contacts, ChatsViewHolder&gt; adapter =&#10;                new FirebaseRecyclerAdapter&lt;Contacts, ChatsViewHolder&gt;(options) {&#10;                    @Override&#10;                    protected void onBindViewHolder(@NonNull final ChatsViewHolder holder, int position, @NonNull Contacts model)&#10;                    {&#10;                        final String usersIDs = getRef(position).getKey();&#10;                        final String[] retImage = {&quot;default_image&quot;};&#10;                        final String[] retName = {&quot;User&quot;};&#10;&#10;                        // Remove old listener if it exists&#10;                        if (userListenersMap.containsKey(usersIDs)) {&#10;                            UsersRef.child(usersIDs).removeEventListener(userListenersMap.get(usersIDs));&#10;                        }&#10;&#10;                        // Create a new ValueEventListener that updates whenever the user data changes&#10;                        ValueEventListener userListener = new ValueEventListener() {&#10;                            @Override&#10;                            public void onDataChange(DataSnapshot dataSnapshot)&#10;                            {&#10;                                if (dataSnapshot.exists())&#10;                                {&#10;                                    if (dataSnapshot.hasChild(&quot;image&quot;))&#10;                                    {&#10;                                        retImage[0] = dataSnapshot.child(&quot;image&quot;).getValue().toString();&#10;                                        if (retImage[0] != null &amp;&amp; !retImage[0].isEmpty()) {&#10;                                            Picasso.get().load(retImage[0]).into(holder.profileImage);&#10;                                        }&#10;                                    }&#10;&#10;                                    if (dataSnapshot.hasChild(&quot;name&quot;))&#10;                                    {&#10;                                        retName[0] = dataSnapshot.child(&quot;name&quot;).getValue().toString();&#10;                                        holder.userName.setText(retName[0]);&#10;                                    }&#10;&#10;                                    // Update user status - this is the key part that checks if online/offline&#10;                                    if (dataSnapshot.hasChild(&quot;userState&quot;))&#10;                                    {&#10;                                        if (dataSnapshot.child(&quot;userState&quot;).hasChild(&quot;state&quot;))&#10;                                        {&#10;                                            String state = dataSnapshot.child(&quot;userState&quot;).child(&quot;state&quot;).getValue().toString();&#10;                                            &#10;                                            if (state != null) {&#10;                                                if (state.equals(&quot;online&quot;))&#10;                                                {&#10;                                                    holder.userStatus.setText(&quot;online&quot;);&#10;                                                }&#10;                                                else if (state.equals(&quot;offline&quot;))&#10;                                                {&#10;                                                    String date = &quot;&quot;;&#10;                                                    String time = &quot;&quot;;&#10;                                                    &#10;                                                    if (dataSnapshot.child(&quot;userState&quot;).hasChild(&quot;date&quot;)) {&#10;                                                        date = dataSnapshot.child(&quot;userState&quot;).child(&quot;date&quot;).getValue().toString();&#10;                                                    }&#10;                                                    if (dataSnapshot.child(&quot;userState&quot;).hasChild(&quot;time&quot;)) {&#10;                                                        time = dataSnapshot.child(&quot;userState&quot;).child(&quot;time&quot;).getValue().toString();&#10;                                                    }&#10;                                                    &#10;                                                    holder.userStatus.setText(&quot;Last Seen: &quot; + date + &quot; &quot; + time);&#10;                                                }&#10;                                            }&#10;                                        }&#10;                                    }&#10;                                    else&#10;                                    {&#10;                                        holder.userStatus.setText(&quot;offline&quot;);&#10;                                    }&#10;                                }&#10;                            }&#10;&#10;                            @Override&#10;                            public void onCancelled(DatabaseError databaseError) {&#10;&#10;                            }&#10;                        };&#10;&#10;                        // Store the listener and add it to continuously monitor user state changes&#10;                        userListenersMap.put(usersIDs, userListener);&#10;                        UsersRef.child(usersIDs).addValueEventListener(userListener);&#10;&#10;                        // Set click listener outside of ValueEventListener to ensure it's always set&#10;                        holder.itemView.setOnClickListener(new View.OnClickListener() {&#10;                            @Override&#10;                            public void onClick(View view)&#10;                            {&#10;                                Intent chatIntent = new Intent(getContext(), ChatActivity.class);&#10;                                chatIntent.putExtra(&quot;visit_user_id&quot;, usersIDs);&#10;                                chatIntent.putExtra(&quot;visit_user_name&quot;, retName[0]);&#10;                                chatIntent.putExtra(&quot;visit_image&quot;, retImage[0]);&#10;                                startActivity(chatIntent);&#10;                            }&#10;                        });&#10;                    }&#10;&#10;                    @NonNull&#10;                    @Override&#10;                    public ChatsViewHolder onCreateViewHolder(@NonNull ViewGroup viewGroup, int i)&#10;                    {&#10;                        View view = LayoutInflater.from(viewGroup.getContext()).inflate(R.layout.users_display_layout, viewGroup, false);&#10;                        return new ChatsViewHolder(view);&#10;                    }&#10;                };&#10;&#10;        if (chatsList != null) {&#10;            chatsList.setAdapter(adapter);&#10;            adapter.startListening();&#10;        }&#10;    }&#10;&#10;&#10;&#10;&#10;    @Override&#10;    public void onDestroy() {&#10;        super.onDestroy();&#10;        // Remove all listeners to prevent memory leaks&#10;        for (String userId : userListenersMap.keySet()) {&#10;            UsersRef.child(userId).removeEventListener(userListenersMap.get(userId));&#10;        }&#10;        userListenersMap.clear();&#10;    }&#10;&#10;&#10;    public static class  ChatsViewHolder extends RecyclerView.ViewHolder&#10;    {&#10;        CircleImageView profileImage;&#10;        TextView userStatus, userName;&#10;&#10;        public ChatsViewHolder(@NonNull View itemView)&#10;        {&#10;            super(itemView);&#10;&#10;            profileImage = itemView.findViewById(R.id.users_profile_image);&#10;            userStatus = itemView.findViewById(R.id.user_status);&#10;            userName = itemView.findViewById(R.id.user_profile_name);&#10;        }&#10;    }&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>